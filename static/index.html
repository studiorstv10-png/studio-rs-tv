<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <title>Studio RS TV — Painel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root { --bg:#0f172a; --card:#111827; --fg:#e5e7eb; --muted:#9ca3af; --pri:#0d1b2a; --acc:#22c55e; --warn:#ef4444; }
    *{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
    body{margin:0;background:var(--bg);color:var(--fg)}
    header{display:flex;gap:12px;align-items:center;padding:14px 18px;background:#0b1220;border-bottom:1px solid #0b1220}
    header h1{font-size:18px;margin:0}
    header small{color:var(--muted)}
    .wrap{display:grid;gap:16px;padding:18px;grid-template-columns:1fr 1fr}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:12px;padding:14px}
    .card h2{margin:0 0 10px 0;font-size:16px}
    label{display:block;margin:8px 0 4px 0;font-size:13px;color:var(--muted)}
    input,select,button{padding:10px 12px;border-radius:8px;border:1px solid #1f2937;background:#0b1220;color:var(--fg);width:100%}
    input::file-selector-button{margin-right:10px;border:1px solid #1f2937;background:#111827;color:var(--fg);padding:8px;border-radius:6px}
    button{cursor:pointer;background:#1d4ed8;border:1px solid #1e40af}
    button.secondary{background:#0b1220}
    .row{display:flex;gap:8px}
    .list{display:flex;flex-direction:column;gap:6px;margin-top:10px}
    .item{display:grid;grid-template-columns:120px 1fr 120px 100px;gap:8px}
    .muted{color:var(--muted);font-size:12px}
    .ok{color:#22c55e}.err{color:#ef4444}
    @media (max-width:900px){ .wrap{grid-template-columns:1fr} .item{grid-template-columns:1fr} }
  </style>
</head>
<body>
<header>
  <h1>Studio RS TV — Painel</h1>
  <small id="brandInfo"></small>
  <span style="margin-left:auto" class="muted">Admin</span>
</header>

<div class="wrap">

  <!-- Marca (esconde se locked) -->
  <section id="card-marca" class="card" hidden>
    <h2>Marca</h2>
    <label>Nome</label>
    <input id="brandName" placeholder="Studio RS TV"/>
    <label>Cor Primária</label>
    <input id="brandColor" placeholder="#0d1b2a"/>
    <label>URL do Logo (png branco, opcional)</label>
    <input id="brandLogo" placeholder="https://.../logo.png"/>
    <div class="row" style="margin-top:10px">
      <button id="btnBrand">Salvar Marca</button>
    </div>
    <div class="muted" id="brandMsg"></div>
  </section>

  <!-- Terminais -->
  <section class="card">
    <h2>Terminais</h2>
    <div class="row">
      <div style="flex:1">
        <label>Código</label>
        <input id="tCode" placeholder="Ex: BOX59"/>
      </div>
      <div style="flex:2">
        <label>Nome visível</label>
        <input id="tName" placeholder="Ex: Açougue 02"/>
      </div>
    </div>
    <div class="row">
      <div style="flex:1">
        <label>Grupo (opcional)</label>
        <input id="tGroup" placeholder="Ex: Matriz"/>
      </div>
      <div style="flex:1">
        <label>&nbsp;</label>
        <button id="btnCreate">Criar</button>
      </div>
    </div>
    <div class="muted" id="tMsg"></div>
  </section>

  <!-- Uploads -->
  <section class="card">
    <h2>Uploads</h2>
    <div class="row">
      <input id="fileInput" type="file" multiple/>
      <button id="btnUpload">Enviar</button>
    </div>
    <div class="list" id="upList"></div>
  </section>

  <!-- Playlist -->
  <section class="card">
    <h2>Playlist</h2>
    <div class="row">
      <select id="selTerm"></select>
      <button class="secondary" id="btnLoadPl">Carregar</button>
    </div>
    <div class="row" style="margin-top:8px">
      <select id="itemType" style="max-width:140px">
        <option value="video">Vídeo</option>
        <option value="image">Imagem</option>
        <option value="rss">RSS</option>
      </select>
      <input id="itemURL" placeholder="URL ou /uploads/arquivo.mp4"/>
      <input id="itemDur" placeholder="Duração (s) para imagem/RSS"/>
      <button id="btnAdd">Adicionar</button>
    </div>

    <div id="plList" class="list"></div>

    <div class="row" style="margin-top:8px">
      <button id="btnSavePl">Salvar Playlist</button>
    </div>
    <div class="muted" id="plMsg"></div>
  </section>

</div>

<script>
const ADMIN_KEY = 'admin123'; // troque se alterar no backend

const $ = sel => document.querySelector(sel);
const brandInfo = $('#brandInfo');
const brandCard = $('#card-marca');
const selTerm = $('#selTerm');
const upList = $('#upList');
const plList = $('#plList');

let terminals = [];
let playlist = [];
let uploadsCache = [];

async function api(url, opts={}){
  const res = await fetch(url, opts);
  const text = await res.text();
  try { return {ok: res.ok, status: res.status, data: JSON.parse(text)}; }
  catch { return {ok: res.ok, status: res.status, data: text}; }
}

async function loadBrand(){
  const r = await api('/api/v1/brand');
  if(r.ok){
    const b = r.data.brand; 
    brandInfo.textContent = `${b.name} • ${b.primary_color}`;
    if(!r.data.locked){
      brandCard.hidden = false;
      $('#brandName').value = b.name||'';
      $('#brandColor').value = b.primary_color||'';
      $('#brandLogo').value = b.logo||'';
    }else{
      brandCard.hidden = true;
    }
  }
}

async function loadTerms(){
  const r = await api('/api/v1/admin/terminals');
  if(r.ok){
    terminals = r.data.items || [];
    selTerm.innerHTML = '';
    terminals.forEach(t=>{
      const o = document.createElement('option');
      o.value = t.code;
      o.textContent = `${t.code} — ${t.name}`;
      selTerm.appendChild(o);
    });
  }
}

async function createTerminal(){
  const code  = $('#tCode').value.trim();
  const name  = $('#tName').value.trim();
  const group = $('#tGroup').value.trim();
  const r = await api('/api/v1/admin/terminals', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({key: ADMIN_KEY, code, name, group})
  });
  const msg = $('#tMsg');
  if(r.ok){ msg.textContent = 'Criado com sucesso.'; loadTerms(); }
  else{
    msg.textContent = `Erro: ${r.data.error||r.status}`;
  }
}

function renderUploads(){
  upList.innerHTML = '';
  uploadsCache.forEach(u=>{
    const d = document.createElement('div');
    d.className = 'muted';
    d.textContent = u;
    upList.appendChild(d);
  });
}

async function doUpload(){
  const inp = $('#fileInput');
  const files = Array.from(inp.files||[]);
  for(const f of files){
    const fd = new FormData();
    fd.append('file', f);
    const r = await fetch('/api/v1/upload', {method:'POST', body:fd});
    const j = await r.json();
    if(j.ok){ uploadsCache.unshift(j.url); }
  }
  renderUploads();
  inp.value = '';
}

function renderPlaylist(){
  plList.innerHTML = '';
  playlist.forEach((it, i)=>{
    const row = document.createElement('div');
    row.className = 'item';
    row.innerHTML = `
      <input value="${it.type}" disabled/>
      <input value="${it.url}" disabled/>
      <input value="${it.duration??''}" disabled/>
      <button data-i="${i}" class="secondary">remover</button>
    `;
    row.querySelector('button').onclick = e=>{
      const idx = +e.currentTarget.dataset.i;
      playlist.splice(idx,1);
      renderPlaylist();
    };
    plList.appendChild(row);
  });
}

function addItem(){
  let type = $('#itemType').value;
  let url  = $('#itemURL').value.trim();
  let dur  = $('#itemDur').value.trim();
  if(!url) return;
  const item = {type, url};
  if(type !== 'video'){
    item.duration = parseInt(dur||'10',10);
  }
  playlist.push(item);
  $('#itemURL').value = '';
  $('#itemDur').value = '';
  renderPlaylist();
}

async function loadPlaylist(){
  const code = selTerm.value;
  const r = await api(`/api/v1/playlist?code=${encodeURIComponent(code)}`);
  if(r.ok){ playlist = r.data.items||[]; renderPlaylist(); }
}

async function savePlaylist(){
  const code = selTerm.value;
  const r = await api('/api/v1/playlist', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({key: ADMIN_KEY, code, items: playlist})
  });
  const el = $('#plMsg');
  if(r.ok){ el.textContent = 'Playlist salva.'; }
  else { el.textContent = `Erro: ${r.data.error||r.status}`; }
}

// Eventos
$('#btnBrand')?.addEventListener('click', async ()=>{
  const r = await api('/api/v1/brand', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      key: ADMIN_KEY,
      name: $('#brandName').value.trim(),
      primary_color: $('#brandColor').value.trim(),
      logo: $('#brandLogo').value.trim()
    })
  });
  $('#brandMsg').textContent = r.ok ? 'OK' : `Erro: ${r.data.error||r.status}`;
});

$('#btnCreate').onclick = createTerminal;
$('#btnUpload').onclick = doUpload;
$('#btnAdd').onclick = addItem;
$('#btnLoadPl').onclick = loadPlaylist;
$('#btnSavePl').onclick = savePlaylist;

(async function init(){
  await loadBrand();
  await loadTerms();
})();
</script>
</body>
</html>
