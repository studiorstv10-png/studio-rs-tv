<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>{{ branding.name }} — Painel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --primary: {{ branding.primary_color|e }};
      --bg: #0b1620;
      --card: #0f1e2b;
      --text: #e7eef7;
      --muted: #9bb2c9;
      --ok: #24d19a;
      --warn: #ffcc00;
      --danger: #ff6b6b;
    }
    *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    header{display:flex;align-items:center;gap:14px;padding:16px 20px;border-bottom:1px solid #142535;background:#0a1520;position:sticky;top:0}
    header img{height:34px}
    header h1{font-size:16px;margin:0}
    .tag{font-size:12px;color:#fff;background:var(--primary);padding:2px 8px;border-radius:999px}
    main{max-width:1100px;margin:24px auto;padding:0 16px;display:grid;gap:18px}
    .card{background:var(--card);padding:16px;border:1px solid #193047;border-radius:12px}
    h2{font-size:16px;margin:0 0 12px 0;color:#fff}
    label{display:block;margin:10px 0 6px 2px;color:var(--muted);font-size:12px}
    input,select,button,textarea{border:1px solid #28465d;background:#0c1a25;color:#eaf3ff;border-radius:10px;padding:10px 12px;font-size:14px}
    input,select,textarea{width:100%}
    .row{display:grid;gap:12px}
    .row.cols-3{grid-template-columns:1fr 1fr 140px}
    .row.cols-2{grid-template-columns:1fr 160px}
    .btn{background:var(--primary);border-color:transparent;color:#fff;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn.secondary{background:#163149}
    .list{display:grid;gap:8px}
    .item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border:1px solid #243d51;background:#0b1924;border-radius:10px}
    .item small{color:var(--muted)}
    .stack{display:flex;gap:8px;flex-wrap:wrap}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .pill{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #2a4a61;background:#0b1a24}
    .ok{color:var(--ok)} .muted{color:var(--muted)}
    .hr{height:1px;background:#1a2d3d;margin:16px 0}
    .hint{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
<header>
  {% if branding.logo_url %}
    <img src="{{ branding.logo_url }}" alt="logo" />
  {% endif %}
  <h1>{{ branding.name }}</h1>
  <span class="tag">{{ branding.primary_color }}</span>
</header>

<main>
  <!-- Terminais -->
  <section class="card">
    <h2>Terminais</h2>
    <div class="row cols-3">
      <div>
        <label>Código (ex.: BOX-0001)</label>
        <input id="t-code" placeholder="BOX-0001" />
      </div>
      <div>
        <label>Nome (ex.: Açougue02)</label>
        <input id="t-name" placeholder="AÇOUGUE02" />
      </div>
      <div>
        <label>Grupo (opcional)</label>
        <input id="t-group" placeholder="MATRIZ" />
      </div>
    </div>
    <div style="margin-top:10px">
      <button class="btn" id="btn-create">Criar</button>
    </div>

    <div class="hr"></div>

    <div class="list" id="term-list">
      <!-- Terminais aparecem aqui -->
    </div>
  </section>

  <!-- Uploads -->
  <section class="card">
    <h2>Uploads</h2>
    <div class="row cols-2">
      <input type="file" id="up-files" multiple />
      <button class="btn" id="btn-upload">Enviar</button>
    </div>
    <div class="hint" style="margin-top:8px">Formatos aceitos: mp4, mov, mkv, webm, jpg, jpeg, png, gif</div>
    <div class="list" id="up-list" style="margin-top:12px"></div>
  </section>

  <!-- Playlist -->
  <section class="card">
    <h2>Playlist</h2>
    <div class="row cols-3">
      <select id="pl-terminal"></select>
      <button class="btn secondary" id="btn-load-pl">Carregar Playlist</button>
      <span></span>
    </div>

    <div class="row cols-3" style="margin-top:10px">
      <select id="pl-type">
        <option value="video">Vídeo</option>
        <option value="image">Imagem</option>
        <option value="rss">RSS</option>
      </select>
      <input id="pl-url" placeholder="URL ou /static/uploads/arquivo.ext" />
      <input id="pl-dur" placeholder="Duração (s) p/ imagem/RSS" />
    </div>
    <div style="margin-top:10px">
      <button class="btn" id="btn-add-item">Adicionar</button>
      <button class="btn" id="btn-save-pl" style="margin-left:8px">Salvar Playlist</button>
    </div>

    <div class="list" id="pl-list" style="margin-top:12px"></div>
  </section>
</main>

<script>
const $ = sel => document.querySelector(sel);
const api = (u, o={}) => fetch(u, o).then(r => r.json());

let currentPlaylist = { code: "", items: [] };

function el(type, props={}, children=[]) {
  const e = document.createElement(type);
  Object.entries(props).forEach(([k,v]) => {
    if (k === "class") e.className = v;
    else if (k === "text") e.textContent = v;
    else e.setAttribute(k, v);
  });
  (Array.isArray(children)?children:[children]).filter(Boolean).forEach(c => e.appendChild(c));
  return e;
}

/* ---------- Terminais ---------- */
async function loadTerminals() {
  const list = await api("/api/v1/terminals");
  const wrap = $("#term-list");
  wrap.innerHTML = "";
  // select da playlist
  const sel = $("#pl-terminal");
  sel.innerHTML = "";
  sel.appendChild(el("option", {value:"", text:"— selecione um terminal —"}));

  list.forEach(t => {
    const line = el("div", {class:"item"}, [
      el("div", {}, [
        el("div", {text: `${t.code} — ${t.name}`}),
        el("small", {class:"muted", text: t.group ? `Grupo: ${t.group}` : "Sem grupo"})
      ]),
      el("div", {class:"stack"}, [
        el("span", {class:"pill"}, [el("span",{class:"mono",text:(t.last_seen||"nunca")})]),
        el("a", {class:"pill", href:`/api/v1/config?code=${encodeURIComponent(t.code)}`, target:"_blank", text:"ver config"})
      ])
    ]);
    wrap.appendChild(line);

    const opt = el("option", {value:t.code, text:`${t.code} — ${t.name}`});
    sel.appendChild(opt);
  });
}

$("#btn-create").onclick = async () => {
  const code = $("#t-code").value.trim();
  const name = $("#t-name").value.trim();
  const group = $("#t-group").value.trim();
  if (!code || !name) { alert("Preencha código e nome."); return; }
  const r = await fetch("/api/v1/terminals", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({code, name, group})
  });
  if (!r.ok) {
    const j = await r.json().catch(()=>({}));
    alert(j.error || "Erro ao criar terminal");
    return;
  }
  $("#t-code").value = ""; $("#t-name").value = ""; $("#t-group").value = "";
  await loadTerminals();
};

/* ---------- Uploads ---------- */
async function loadUploads() {
  const list = await api("/api/v1/uploads");
  const wrap = $("#up-list");
  wrap.innerHTML = "";
  list.forEach(u => {
    const line = el("div", {class:"item"}, [
      el("div", {}, [
        el("div",{text:u.name}),
        el("small",{class:"muted", text:`${u.type} • ${u.bytes} bytes`})
      ]),
      el("div",{class:"stack"},[
        el("a",{class:"pill", href:u.url, target:"_blank", text:"abrir"}),
        el("button",{class:"pill", onclick:()=>{$("#pl-url").value=u.url}}, "usar")
      ])
    ]);
    wrap.appendChild(line);
  });
}

$("#btn-upload").onclick = async () => {
  const files = $("#up-files").files;
  if (!files || !files.length) { alert("Selecione ao menos um arquivo."); return; }
  const fd = new FormData();
  [...files].forEach(f => fd.append("files", f));
  const r = await fetch("/api/v1/upload", { method:"POST", body: fd });
  const j = await r.json();
  if (!j.ok) { alert("Erro no upload."); return; }
  $("#up-files").value = "";
  await loadUploads();
};

/* ---------- Playlist ---------- */
function renderPlaylist() {
  const wrap = $("#pl-list");
  wrap.innerHTML = "";
  currentPlaylist.items.forEach((it, idx) => {
    const head = it.type.toUpperCase();
    const dur = (it.type === "image" || it.type === "rss") ? ` • ${it.duration || 10}s` : "";
    const row = el("div",{class:"item"},[
      el("div",{},[
        el("div",{text:`[${head}] ${it.url}`}),
        el("small",{class:"muted",text:dur})
      ]),
      el("div",{class:"stack"},[
        el("a",{class:"pill",href:it.url,target:"_blank",text:"ver"}),
        el("button",{class:"pill",onclick:()=>removeItem(idx)}, "remover")
      ])
    ]);
    wrap.appendChild(row);
  });
}

function removeItem(i){
  currentPlaylist.items.splice(i,1);
  renderPlaylist();
}

$("#btn-add-item").onclick = () => {
  const type = $("#pl-type").value;
  const url = $("#pl-url").value.trim();
  const dur = parseInt($("#pl-dur").value || "10",10);
  if (!currentPlaylist.code) { alert("Selecione um terminal."); return; }
  if (!url) { alert("Informe a URL."); return; }
  const item = {type, url};
  if (type === "image" || type === "rss") item.duration = dur;
  currentPlaylist.items.push(item);
  $("#pl-url").value = ""; $("#pl-dur").value = "";
  renderPlaylist();
};

$("#btn-load-pl").onclick = async () => {
  const code = $("#pl-terminal").value;
  if (!code) { alert("Selecione o terminal."); return; }
  const j = await api(`/api/v1/playlist/${encodeURIComponent(code)}`);
  currentPlaylist = { code, items: j.items || [] };
  renderPlaylist();
};

$("#btn-save-pl").onclick = async () => {
  if (!currentPlaylist.code) { alert("Selecione o terminal."); return; }
  const r = await fetch(`/api/v1/playlist/${encodeURIComponent(currentPlaylist.code)}`, {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({items: currentPlaylist.items})
  });
  if (!r.ok){ alert("Erro ao salvar."); return; }
  alert("Playlist salva.");
};

/* Init */
loadTerminals();
loadUploads();
</script>
</body>
</html>
