<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>{{ brand.name }} — Painel</title>
  <style>
    :root { --brand: {{ brand.primary_color|default('#0d1b2a') }}; }
    *{ box-sizing:border-box }
    body{ margin:0; background:#0b0e11; color:#e9eef5; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif }
    header{ background:var(--brand); padding:16px 20px; display:flex; align-items:center; gap:12px }
    header img{ height:36px; display:block }
    header .title{ font-weight:800 }
    main{ max-width:1200px; margin:0 auto; padding:20px }
    .grid{ display:grid; grid-template-columns:repeat(12,1fr); gap:16px }
    .card{ grid-column:span 12; background:#11161c; border:1px solid #1b2530; border-radius:12px; padding:16px }
    @media (min-width:900px){ .col-4{grid-column:span 4} .col-6{grid-column:span 6} .col-12{grid-column:span 12} }
    h2{ margin:0 0 10px; font-size:16px; font-weight:800 }
    label{ display:block; font-size:13px; margin:10px 0 6px; color:#9fb3c8 }
    input[type="text"],input[type="url"],select,textarea{
      width:100%; padding:10px 12px; border-radius:8px; border:1px solid #293341; background:#0e141a; color:#e9eef5
    }
    textarea{ min-height:84px; resize:vertical }
    input::placeholder,textarea::placeholder{ color:#6e8297 }
    .row{ display:flex; gap:12px }
    .row > div{ flex:1 }
    .btn{ display:inline-block; margin-top:12px; padding:10px 14px; border-radius:8px;
          background:#0e141a; border:1px solid #2a3645; color:#e9eef5; cursor:pointer; text-decoration:none }
    .btn.primary{ background:var(--brand); border-color:transparent }
    .muted{ color:#9fb3c8; font-size:13px }
    ul.list{ list-style:none; padding:0; margin:6px 0 0; max-height:240px; overflow:auto }
    ul.list li{ display:flex; align-items:center; justify-content:space-between; gap:10px;
                padding:8px 10px; border:1px solid #22303d; border-radius:8px; margin-bottom:8px; background:#0f141a; font-size:14px }
    ul.list code{ color:#cfe3ff; font-size:12px }
    table{ width:100%; border-collapse:collapse; font-size:14px }
    th,td{ border:1px solid #22303d; padding:8px; text-align:left }
    .dot{ width:10px; height:10px; border-radius:50%; display:inline-block; vertical-align:middle; margin-right:6px }
    .ok{ background:#38d996 } .off{ background:#ff6b6b }
    details{ border:1px solid #22303d; border-radius:10px; padding:10px; background:#0f141a; margin:8px 0 }
    summary{ cursor:pointer; font-weight:700 }
    footer{ text-align:center; color:#9fb3c8; padding:14px; border-top:1px solid #1b2530; margin-top:24px }
    footer a{ color:#b9d6ff; text-decoration:none } footer a:hover{ text-decoration:underline }
  </style>
</head>
<body>
<header>
  <img src="{{ brand.logo }}" alt="logo" onerror="this.src='/static/logo.png'">
  <div class="title">{{ brand.name }} — Painel</div>
  <div style="margin-left:auto" class="muted">Tema ativo</div>
</header>

<main>
  <div class="grid">

    <!-- Terminais (unitário) + Parear código -->
    <section class="card col-6">
      <h2>Terminais (unitário)</h2>
      <div class="row">
        <div><label>Nome</label><input id="tname" placeholder="BOX-001"></div>
        <div><label>Código (opcional)</label><input id="tcode" placeholder="001"></div>
      </div>
      <div class="row">
        <div><label>Cliente</label><input id="client" placeholder="Nome do Cliente"></div>
        <div><label>Grupo / Setor</label><input id="group" placeholder="Açougue, Bebidas..."></div>
      </div>
      <button class="btn primary" onclick="saveTerminal()">Criar / Atualizar</button>
      <div id="tmsg" class="muted" style="margin-top:8px"></div>

      <hr style="border:none;border-top:1px solid #1b2530;margin:16px 0">
      <h2>Parear Box (código mostrado na TV)</h2>
      <div class="row">
        <div><label>Código de pareamento</label><input id="pairCode" placeholder="ABC123"></div>
        <div><label>Terminal</label><select id="pairTerminal"></select></div>
      </div>
      <button class="btn" onclick="pairClaim()">Vincular</button>
      <div id="pairMsg" class="muted" style="margin-top:8px"></div>
    </section>

    <!-- Criar em Lote -->
    <section class="card col-6">
      <h2>Criação em Lote por Cliente</h2>
      <div class="row">
        <div><label>Cliente</label><input id="bulkClient" placeholder="João"></div>
        <div><label>Base do nome</label><input id="bulkBase" placeholder="BOX" value="BOX"></div>
        <div><label>Quantidade</label><input id="bulkCount" placeholder="10" value="5"></div>
      </div>
      <div class="row">
        <div><label>Início do código</label><input id="bulkStart" placeholder="1" value="1"></div>
        <div><label>Dígitos do código</label><input id="bulkDigits" placeholder="3" value="3"></div>
      </div>
      <label>Grupos / Setores (opcional — uma linha por terminal, na ordem)</label>
      <textarea id="bulkGroups" placeholder="Bebidas&#10;Açougue&#10;Caixa"></textarea>
      <button class="btn" onclick="createBulk()">Criar Lote</button>
      <div id="bulkMsg" class="muted" style="margin-top:8px"></div>
    </section>

    <!-- Uploads -->
    <section class="card col-12">
      <h2>Uploads</h2>
      <form id="upForm">
        <input type="file" id="files" name="files" multiple />
        <button class="btn" type="submit">Enviar</button>
      </form>
      <div class="muted" id="upMsg"></div>
      <ul class="list" id="uploadsList"></ul>
    </section>

    <!-- Campanha -->
    <section class="card col-12">
      <h2>Campanha (playlist nomeada)</h2>
      <div class="row">
        <div class="col"><label>Nome da campanha</label><input id="campName" placeholder="Semana do Cliente"></div>
        <div class="col"><label>Carregar playlist do terminal</label>
          <div class="row">
            <div><select id="plTerminal"></select></div>
            <div><button class="btn" onclick="loadPlaylist()">Carregar Playlist</button></div>
          </div>
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label>Alvos (segure CTRL/CMD para múltiplos)</label>
          <select id="plTargets" multiple size="7"></select>
        </div>
        <div style="flex:2">
          <label>Adicionar itens</label>
          <div class="row">
            <div>
              <select id="plType">
                <option value="video">Vídeo</option>
                <option value="image">Imagem</option>
                <option value="rss">RSS</option>
              </select>
            </div>
            <div>
              <select id="fromUploads"></select>
            </div>
            <div>
              <input id="plUrl" placeholder="/static/uploads/arquivo.ext ou https://..." />
            </div>
            <div>
              <input id="plDur" type="text" value="10" title="Duração p/ imagem/RSS (s)"/>
            </div>
            <div><button class="btn" onclick="addItem()">Adicionar</button></div>
          </div>
          <ul class="list" id="plist"></ul>
          <button class="btn primary" onclick="saveCampaign()">Salvar campanha</button>
        </div>
      </div>
    </section>

    <!-- Clientes & Terminais (hierárquico) -->
    <section class="card col-12">
      <div style="display:flex; align-items:center; gap:10px">
        <h2 style="margin:0">Clientes & Terminais</h2>
        <button class="btn" onclick="renderClients()">Atualizar</button>
      </div>
      <div id="clientsView"></div>
    </section>

    <!-- Diagnóstico -->
    <section class="card col-12">
      <h2>Diagnóstico</h2>
      <div class="row">
        <div><button class="btn" onclick="diag('/api/v1/ping')">/api/v1/ping</button></div>
        <div><button class="btn" onclick="diag('/api/v1/campaigns')">/api/v1/campaigns</button></div>
      </div>
      <pre id="diag" class="muted" style="white-space:pre-wrap; margin-top:10px;"></pre>
    </section>

  </div>
</main>

<footer>
  Desenvolvido por: <strong>Studio RS Ilhabela</strong> —
  <a href="{{ brand.support_wa }}" target="_blank" rel="noopener">Abrir suporte no WhatsApp</a>
</footer>

<script>
  const $=(id)=>document.getElementById(id);
  const selValue=(id)=>{const s=$(id);return s&&s.value;}

  // ---------- Terminais (unitário) ----------
  async function refreshTerminals(){
    const r=await fetch('/api/v1/terminals'); const j=await r.json();
    const opts=(j.items||[]).map(t=>{
      const key=(t.code||t.name);
      return `<option value="${key}">${t.name} — ${t.client||'s/cliente'} ${t.group?('('+t.group+')'):''}</option>`
    }).join('');
    $('plTerminal').innerHTML=opts;
    $('plTargets').innerHTML=opts;
    $('pairTerminal').innerHTML=opts;
  }
  async function saveTerminal(){
    const payload={
      name:$('tname').value.trim(),
      code:$('tcode').value.trim(),
      client:$('client').value.trim(),
      group:$('group').value.trim()
    };
    const r=await fetch('/api/v1/terminals',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const j=await r.json(); $('tmsg').textContent=j.ok?'Terminal salvo!':(j.error||'Erro');
    $('tname').value=''; $('tcode').value=''; $('client').value=''; $('group').value='';
    await refreshTerminals(); await renderClients();
  }

  // ---------- Terminais (lote) ----------
  async function createBulk(){
    const groupsText=$('bulkGroups').value.trim();
    const groups = groupsText ? groupsText.split('\n').map(s=>s.trim()).filter(Boolean) : [];
    const payload={
      client:$('bulkClient').value.trim(),
      base_name:$('bulkBase').value.trim(),
      count:parseInt($('bulkCount').value||'0',10)||0,
      code_start:parseInt($('bulkStart').value||'1',10)||1,
      code_digits:parseInt($('bulkDigits').value||'3',10)||3,
      groups
    };
    const r=await fetch('/api/v1/terminals/bulk',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const j=await r.json(); $('bulkMsg').textContent=j.ok?`Criados: ${j.created.length}`:(j.error||'Erro');
    await refreshTerminals(); await renderClients();
  }

  // ---------- Uploads ----------
  async function refreshUploads(){
    const r=await fetch('/api/v1/uploads'); const j=await r.json();
    $('uploadsList').innerHTML='';
    $('fromUploads').innerHTML='<option value="">-- Escolher dos uploads --</option>';
    (j.items||[]).forEach(it=>{
      const li=document.createElement('li');
      li.innerHTML=`<span>${it.name} <code>${it.type}</code></span>
                    <span><a class="btn" href="${it.url}" target="_blank">abrir</a>
                    <button class="btn" onclick="useUpload('${it.url}','${it.type}')">usar</button></span>`;
      $('uploadsList').appendChild(li);
      const o=document.createElement('option'); o.value=it.url; o.textContent=`${it.type}: ${it.name}`;
      $('fromUploads').appendChild(o);
    });
  }
  $('upForm').addEventListener('submit',async(e)=>{
    e.preventDefault();
    const data=new FormData();
    for(const f of $('files').files) data.append('files',f);
    $('upMsg').textContent='Enviando...';
    const r=await fetch('/api/v1/upload',{method:'POST',body:data}); const j=await r.json();
    $('upMsg').textContent=j.ok?'Ok!':(j.error||'Erro'); await refreshUploads();
  });
  function useUpload(url,type){ $('plUrl').value=url; $('plType').value=type; }

  // ---------- Campanha ----------
  let items=[];
  function renderPlaylist(){
    const ul=$('plist'); ul.innerHTML='';
    items.forEach((it,i)=>{
      const li=document.createElement('li');
      li.innerHTML=`<span>${i+1}. ${it.type} — <code>${it.url}</code>${it.type==='image'||it.type==='rss'?` — ${it.duration}s`:''}</span>
                    <button class="btn" onclick="items.splice(${i},1);renderPlaylist()">remover</button>`;
      ul.appendChild(li);
    });
  }
  function addItem(){
    const type=selValue('plType'); const from=selValue('fromUploads');
    const url=($('plUrl').value.trim()||from);
    if(!url){ alert('Informe URL ou escolha dos uploads.'); return; }
    let dur=0; if(type==='image'||type==='rss'){ dur=parseInt($('plDur').value||'10',10)||10; }
    items.push({type,url,duration:dur}); $('plUrl').value=''; $('fromUploads').value=''; renderPlaylist();
  }
  async function loadPlaylist(){
    const term=selValue('plTerminal'); if(!term){ alert('Selecione um terminal.'); return; }
    const r=await fetch(`/api/v1/playlists/${encodeURIComponent(term)}`); const j=await r.json();
    items=j.items||[]; renderPlaylist();
  }
  async function saveCampaign(){
    const name=$('campName').value.trim(); if(!name){ alert('Dê um nome à campanha.'); return; }
    const sel=[...$('plTargets').selectedOptions].map(o=>o.value);
    if(sel.length===0){ alert('Selecione 1+ terminais nos alvos.'); return; }
    if(items.length===0){ alert('Adicione ao menos 1 item na campanha.'); return; }
    const r=await fetch('/api/v1/campaigns/save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,items,targets:sel})});
    const j=await r.json(); if(j.ok){ alert('Campanha salva!'); renderClients(); } else { alert(j.error||'Erro'); }
  }
  function focusTerminal(code){
    [...$('plTargets').options].forEach(o=>o.selected = (o.value===code));
    [...$('plTerminal').options].forEach(o=>{ if(o.value===code) $('plTerminal').value=code; });
    loadPlaylist();
    window.scrollTo({top:0,behavior:'smooth'});
  }
  async function loadOnly(code){
    $('plTerminal').value = code;
    await loadPlaylist();
  }

  // ---------- Clientes & Terminais ----------
  async function renderClients(){
    const r=await fetch('/api/v1/status'); const j=await r.json(); const list=j.items||[];
    const clients={};
    list.forEach(it=>{
      const c=it.client||'Sem cliente';
      clients[c]=clients[c]||{name:c, items:[], online:0, total:0};
      clients[c].items.push(it);
      clients[c].total++;
      if(it.online) clients[c].online++;
    });

    const wrap=$('clientsView'); wrap.innerHTML='';
    Object.values(clients).sort((a,b)=>a.name.localeCompare(b.name)).forEach(c=>{
      const det=document.createElement('details');
      det.innerHTML=`<summary>${c.name} — ${c.online}/${c.total} online</summary>`;
      const table=document.createElement('table');
      table.innerHTML=`
        <thead><tr>
          <th>Terminal</th><th>Grupo</th><th>Campanha</th>
          <th>Estado</th><th>Último</th><th>Tocando</th><th>Ações</th>
        </tr></thead><tbody></tbody>`;
      const tb=table.querySelector('tbody');
      c.items.sort((a,b)=>(a.name||a.code||'').localeCompare(b.name||b.code||'')).forEach(it=>{
        const tr=document.createElement('tr');
        const dot=`<span class="dot ${it.online?'ok':'off'}"></span>${it.online?'Online':'Offline'}`;
        const playing=it.playing&&it.playing.url ? (it.playing.type+' — '+it.playing.url) : '-';
        tr.innerHTML=`
          <td>${it.name||it.code||'-'}</td>
          <td>${it.group||'-'}</td>
          <td>${it.campaign||'-'}</td>
          <td>${dot}</td>
          <td>${it.last_seen||'-'}</td>
          <td>${playing}</td>
          <td>
            <button class="btn" onclick="focusTerminal('${it.code||it.name}')">Editar Playlist</button>
            <button class="btn" onclick="loadOnly('${it.code||it.name}')">Carregar Playlist</button>
          </td>`;
        tb.appendChild(tr);
      });
      det.appendChild(table);
      wrap.appendChild(det);
    });
  }

  // ---------- Pareamento ----------
  async function pairClaim(){
    const code=$('pairCode').value.trim().toUpperCase();
    const terminal=selValue('pairTerminal');
    if(!code||!terminal){ $('pairMsg').textContent='Informe o código e o terminal.'; return; }
    const r=await fetch('/api/v1/pair/claim',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code,terminal})});
    const j=await r.json();
    $('pairMsg').textContent = j.ok ? 'Vinculado com sucesso! O box vai reconhecer em instantes.' : (j.error||'Erro');
    if(j.ok){ $('pairCode').value=''; }
  }

  // ---------- Diagnóstico ----------
  async function diag(url){ const r=await fetch(url); const j=await r.json(); $('diag').textContent=JSON.stringify(j,null,2); }

  // ---------- init ----------
  (async function init(){
    await refreshTerminals();
    await refreshUploads();
    await renderClients();
  })();
</script>
</body>
</html>
