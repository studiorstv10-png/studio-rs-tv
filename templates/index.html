<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>{{ branding.name or 'Studio RS TV' }} — Painel</title>
<style>
  :root { --bg:#0b1220; --fg:#e8eefc; --muted:#94a3b8; --card:#111827; --ok:#22c55e; --bad:#ef4444; --brand: {{ branding.primary_color or '#0d1b2a' }};}
  body{background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; margin:0;padding:24px}
  h1{margin:0 0 16px 0;font-size:22px}
  a{color:#93c5fd;text-decoration:none}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:var(--card);border-radius:10px;padding:14px}
  .grid{display:grid;gap:10px}
  .btn{background:#2563eb;border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
  .btn.alt{background:#374151}
  .btn.warn{background:#f59e0b}
  .btn.ok{background:#16a34a}
  input,select{width:100%;padding:8px;border-radius:8px;border:1px solid #334155;background:#0f172a;color:var(--fg)}
  label{font-size:12px;color:var(--muted)}
  .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}.mt24{margin-top:24px}
  .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .upload-list{max-height:260px;overflow:auto;border:1px dashed #334155;border-radius:8px;padding:6px}
  .pill{font-size:12px;padding:2px 8px;border-radius:999px;background:#0f172a;border:1px solid #334155;color:#cbd5e1}
  .status{font-size:12px}
  .okdot{width:8px;height:8px;border-radius:50%;background:var(--ok);display:inline-block;margin-right:6px}
  .baddot{width:8px;height:8px;border-radius:50%;background:var(--bad);display:inline-block;margin-right:6px}
  .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
  .badge{background:var(--brand);color:#fff;padding:2px 8px;border-radius:999px;font-size:12px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand img{height:26px}
  footer{margin-top:24px;color:#9aa2b2;font-size:12px}
</style>
</head>
<body>

<header>
  <div class="brand">
    {% if branding.logo_url %}
      <img src="{{ branding.logo_url }}" alt="logo">
    {% endif %}
    <h1>{{ branding.name or 'Studio RS TV' }} — Painel</h1>
  </div>
  <a class="btn alt" href="{{ support_link }}" target="_blank">Suporte WhatsApp</a>
</header>

<!-- BLOCO: Clientes & Terminais -->
<div class="card">
  <div class="flex" style="justify-content:space-between">
    <strong>Clientes & Terminais</strong>
    <button class="btn alt" onclick="loadSummary()">Atualizar lista</button>
  </div>
  <div id="summary" class="cards mt12"></div>
</div>

<div class="row mt16">
  <!-- CLIENTE / TERMINAIS -->
  <div class="card">
    <strong>Cliente & Terminais</strong>
    <div class="grid mt8">
      <div>
        <label>Nome do cliente</label>
        <input id="c_name" placeholder="ex.: Frade" />
      </div>
      <div>
        <label>Código do cliente</label>
        <input id="c_code" placeholder="ex.: 001" />
      </div>
      <div>
        <label>Qtd terminais</label>
        <input id="c_terms" type="number" min="1" value="1" />
      </div>
      <div>
        <label>Licença (dias)</label>
        <input id="c_days" type="number" min="1" value="30" />
      </div>
    </div>
    <button class="btn mt12" onclick="createClient()">Criar/Atualizar</button>

    <div class="mt16">
      <label>Selecionar terminal (topo)</label>
      <select id="top_terminal"></select>
      <button class="btn alt mt8" onclick="loadPlaylistFromTop()">Carregar Playlist</button>
    </div>
  </div>

  <!-- UPLOADS -->
  <div class="card">
    <strong>Uploads</strong>
    <div class="flex mt8">
      <input id="file" type="file" multiple />
      <button class="btn" onclick="sendFiles()">Enviar</button>
    </div>
    <div id="uploads" class="upload-list mt12"></div>
  </div>
</div>

<!-- PLAYLIST -->
<div class="card mt16">
  <strong>Playlist por Terminal</strong>
  <div class="grid mt8">
    <div>
      <label>Terminal (playlist)</label>
      <select id="pl_terminal"></select>
    </div>
    <div class="flex">
      <button class="btn alt" onclick="syncTop()">Sincronizar com topo</button>
      <button class="btn" onclick="loadPlaylist()">Carregar Playlist</button>
    </div>
  </div>

  <div class="grid mt16">
    <div class="flex" style="gap:12px">
      <select id="item_type">
        <option value="video">Vídeo</option>
        <option value="image">Imagem</option>
        <option value="rss">RSS</option>
      </select>
      <select id="item_pick"></select>
      <input id="item_url" placeholder="URL ou /static/uploads/arquivo.ext" />
      <input id="item_dur" type="number" min="1" placeholder="Duração (s) para imagem/RSS" />
      <button class="btn" onclick="addItem()">Adicionar</button>
      <button class="btn ok" onclick="savePlaylist()">Salvar Playlist</button>
    </div>
  </div>

  <div id="playlist" class="grid mt12"></div>
</div>

<footer>
  Desenvolvido por: Studio RS Ilhabela — suporte via botão no topo.
</footer>

<script>
const qs = s => document.querySelector(s);
const api = (u, opt={}) => fetch(u, Object.assign({headers:{'Content-Type':'application/json'}}, opt));

let STATE = { uploads: [], playlist: [], currentCode: "" };

// ---------------- Summary (cartões) ----------------
async function loadSummary(){
  const r = await api('/api/v1/summary');
  const j = await r.json();
  const box = qs('#summary');
  box.innerHTML = '';
  if(!j.ok){ box.innerHTML = '—'; return; }
  // agrupa por cliente
  const by = {};
  j.items.forEach(x=>{
    by[x.client_code] ??= {name:x.client_name, code:x.client_code, terms:[]};
    by[x.client_code].terms.push(x);
  });
  Object.values(by).forEach(cli=>{
    cli.terms.sort((a,b)=>a.term-b.term);
    cli.terms.forEach(t=>{
      const el = document.createElement('div');
      el.className='card';
      el.innerHTML = `
        <div class="flex" style="justify-content:space-between">
          <div>
            <div><span class="badge">${cli.name}</span></div>
            <div class="mt8"><strong>${t.display_code}</strong></div>
            <div class="status mt8">
              ${t.online?'<span class="okdot"></span>online':'<span class="baddot"></span>offline'}
              • itens: ${t.items} • v${t.config_version||0}
            </div>
            ${t.playing?`<div class="mt8"><span class="pill">tocando</span> ${t.playing}</div>`:''}
          </div>
          <div class="grid" style="min-width:140px">
            <button class="btn" onclick="manage('${t.display_code}')">Gerenciar</button>
            <button class="btn alt" onclick="viewConfig('${t.display_code}')">Ver Config</button>
            <button class="btn warn" onclick="restart('${t.display_code}')">Reiniciar</button>
          </div>
        </div>`;
      box.appendChild(el);
    });
  });
}

async function manage(code){
  // carrega detalhe e joga tudo no builder
  const r = await api('/api/v1/terminal?code='+encodeURIComponent(code));
  const j = await r.json();
  if(!j.ok){ alert('Erro ao carregar'); return; }
  // popula selects
  await refreshClientSelects(true); // garante options
  qs('#top_terminal').value = code;
  qs('#pl_terminal').value  = code;
  // uploads
  STATE.uploads = j.uploads || [];
  renderUploads();
  // playlist
  STATE.currentCode = code;
  STATE.playlist = (j.config && j.config.playlist) || [];
  renderPlaylist();
  window.scrollTo({top:0,behavior:'smooth'});
}
function viewConfig(code){ window.open('/api/v1/config?code='+encodeURIComponent(code),'_blank'); }
async function restart(code){ await api('/api/v1/terminal/command',{method:'POST',body:JSON.stringify({code,cmd:'restart'})}); alert('Comando enviado'); }

// ---------------- Cliente / terminais ----------------
async function createClient(){
  const name = qs('#c_name').value.trim();
  const code = qs('#c_code').value.trim();
  const terms= parseInt(qs('#c_terms').value || '1',10);
  const days = parseInt(qs('#c_days').value || '30',10);
  const r = await api('/api/v1/client',{method:'POST',body:JSON.stringify({name,client_code:code,terminals:terms,license_days:days})});
  const j = await r.json();
  if(!j.ok){ alert('Erro: '+(j.error||'falha')); return; }
  await refreshClientSelects();
  await loadSummary();
  alert(`Cliente salvo: ${code}`);
}
async function refreshClientSelects(skipMsg){
  const r = await api('/api/v1/clients');
  const j = await r.json();
  const top = qs('#top_terminal');
  const pl  = qs('#pl_terminal');
  top.innerHTML=''; pl.innerHTML='';
  if(!j.ok) return;
  j.items.forEach(c=>{
    c.terminals.forEach(t=>{
      const code = `${c.code}-${String(t).padStart(2,'0')}`;
      const label = `${c.name} — ${code}`;
      const o1 = new Option(label, code); top.add(o1);
      const o2 = new Option(label, code); pl.add(o2);
    });
  });
  if(!skipMsg) alert('Listas de terminais atualizadas.');
}
function syncTop(){ qs('#pl_terminal').value = qs('#top_terminal').value; }

// ---------------- Uploads ----------------
async function sendFiles(){
  const fileInput = qs('#file');
  if(!fileInput.files.length) return;
  for(const f of fileInput.files){
    const form = new FormData(); form.append('file', f);
    const r = await fetch('/upload',{method:'POST',body:form});
    const j = await r.json();
    if(j.ok) STATE.uploads.unshift({filename:j.filename,url:j.url,type:j.type});
  }
  fileInput.value="";
  renderUploads();
}
async function listUploads(){
  const r = await api('/api/v1/uploads');
  const j = await r.json();
  STATE.uploads = j.ok ? j.items : [];
  renderUploads();
}
function renderUploads(){
  const box = qs('#uploads'); box.innerHTML='';
  STATE.uploads.forEach(u=>{
    const row = document.createElement('div');
    row.className='flex'; row.style.justifyContent='space-between';
    row.innerHTML = `<div>${u.type.toUpperCase()} — <a href="${u.url}" target="_blank">${u.url}</a></div>
                     <div class="flex">
                       <button class="btn alt" onclick="useUpload('${u.url}','${u.type}')">usar</button>
                     </div>`;
    box.appendChild(row);
  });
}
function useUpload(url,type){
  qs('#item_url').value = url;
  qs('#item_type').value = type || 'video';
}

// ---------------- Playlist ----------------
async function loadPlaylistFromTop(){
  qs('#pl_terminal').value = qs('#top_terminal').value;
  await loadPlaylist();
}
async function loadPlaylist(){
  const code = qs('#pl_terminal').value;
  const r = await api('/api/v1/config?code='+encodeURIComponent(code));
  const j = await r.json();
  if(!j.ok){ alert('Erro ao carregar'); return; }
  STATE.currentCode = code;
  STATE.playlist = j.playlist || [];
  renderPlaylist();
}
function renderPlaylist(){
  const box = qs('#playlist'); box.innerHTML='';
  // “lista editável” simples
  STATE.playlist.forEach((it,idx)=>{
    const row = document.createElement('div');
    row.className='flex';
    row.innerHTML = `
      <span class="pill">${it.type}</span>
      <input style="flex:1" value="${it.url}" oninput="STATE.playlist[${idx}].url=this.value" />
      <input type="number" placeholder="duração (img/RSS)" value="${it.duration||0}" 
             oninput="STATE.playlist[${idx}].duration=parseInt(this.value||0,10)" />
      <button class="btn alt" onclick="move(${idx},-1)">↑</button>
      <button class="btn alt" onclick="move(${idx},1)">↓</button>
      <button class="btn warn" onclick="removeItem(${idx})">remover</button>`;
    box.appendChild(row);
  });
}
function move(i,dir){
  const j = i+dir;
  if(j<0 || j>=STATE.playlist.length) return;
  const tmp = STATE.playlist[i];
  STATE.playlist[i]=STATE.playlist[j]; STATE.playlist[j]=tmp;
  renderPlaylist();
}
function removeItem(i){ STATE.playlist.splice(i,1); renderPlaylist(); }
function addItem(){
  const type = qs('#item_type').value;
  const url  = (qs('#item_url').value || '').trim() || qs('#item_pick').value || '';
  if(!url){ alert('Informe URL ou escolha dos uploads'); return; }
  let dur = parseInt(qs('#item_dur').value||'0',10);
  if(type==='image' && dur<=0) dur=10;
  if(type==='video') dur=0;
  STATE.playlist.push({type,url,duration:dur});
  renderPlaylist();
}
// Select rápido “escolher dos uploads”
function fillPicker(){
  const sel = qs('#item_pick'); sel.innerHTML='';
  STATE.uploads.forEach(u=> sel.add(new Option(u.url,u.url)));
}
async function savePlaylist(){
  const code = qs('#pl_terminal').value;
  const body = {
    code,
    items: STATE.playlist,
    refresh_minutes: 10,
    update_schedule_hours: [6,12,18]
  };
  const r = await api('/api/v1/playlist',{method:'POST',body:JSON.stringify(body)});
  const j = await r.json();
  if(!j.ok){ alert('Erro ao salvar: '+(j.error||'falha')); return; }
  alert('Playlist salva (v'+j.config_version+')!');
  await loadSummary(); // atualiza cartões
}

// ---------------- Boot
(async function init(){
  await refreshClientSelects(true);
  await listUploads();
  fillPicker();
  await loadSummary();
})();
</script>
</body>
</html>
