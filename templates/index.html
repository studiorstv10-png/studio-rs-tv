<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>{{ branding.name }} — Painel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --primary: {{ branding.primary_color|e }};
      --bg: #0b1620;
      --card: #0f1e2b;
      --text: #e7eef7;
      --muted: #9bb2c9;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    header{display:flex;align-items:center;gap:12px;padding:14px 18px;border-bottom:1px solid #142535;background:#0a1520;position:sticky;top:0;z-index:10}
    header img{height:32px}
    .color-dot{width:12px;height:12px;border-radius:999px;background:var(--primary);box-shadow:0 0 0 3px #0f1e2b inset}
    h1{font-size:16px;margin:0}
    main{max-width:1100px;margin:22px auto;padding:0 16px;display:grid;gap:18px}
    .card{background:var(--card);padding:16px;border:1px solid #193047;border-radius:12px}
    h2{font-size:16px;margin:0 0 12px 0;color:#fff}
    label{display:block;margin:10px 0 6px 2px;color:var(--muted);font-size:12px}
    input,select,button{border:1px solid #28465d;background:#0c1a25;color:#eaf3ff;border-radius:10px;padding:10px 12px;font-size:14px}
    input,select{width:100%}
    .row{display:grid;gap:12px}
    .row.cols-3{grid-template-columns:1fr 1fr 1fr}
    .row.cols-2{grid-template-columns:1fr 160px}
    .btn{background:var(--primary);border-color:transparent;color:#fff;cursor:pointer}
    .btn.secondary{background:#163149}
    .list{display:grid;gap:8px}
    .item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border:1px solid #243d51;background:#0b1924;border-radius:10px}
    .item small{color:var(--muted)}
    .stack{display:flex;gap:8px;flex-wrap:wrap}
    .pill{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #2a4a61;background:#0b1a24;color:#eaf3ff}
    .muted{color:var(--muted)}
    .hr{height:1px;background:#1a2d3d;margin:16px 0}
    footer{padding:24px 18px;color:var(--muted);text-align:center;border-top:1px solid #142535;background:#0a1520;margin-top:12px}
    footer a{color:#8fc8ff;text-decoration:none}
  </style>
</head>
<body>
<header>
  {% if branding.logo_url %}<img src="{{ branding.logo_url }}" alt="logo">{% endif %}
  <div class="color-dot"></div>
  <h1>{{ branding.name }}</h1>
</header>

<main>
  <!-- Terminais -->
  <section class="card">
    <h2>Terminais</h2>
    <div class="row cols-3">
      <div><label>Código (ex.: BOX-0001)</label><input id="t-code" placeholder="BOX-0001"></div>
      <div><label>Nome (ex.: Açougue02)</label><input id="t-name" placeholder="AÇOUGUE02"></div>
      <div><label>Grupo (opcional)</label><input id="t-group" placeholder="MATRIZ"></div>
    </div>
    <div style="margin-top:10px"><button class="btn" id="btn-create">Criar</button></div>
    <div class="hr"></div>
    <div class="list" id="term-list"></div>
  </section>

  <!-- Uploads -->
  <section class="card">
    <h2>Uploads</h2>
    <div class="row cols-2">
      <input type="file" id="up-files" multiple>
      <button class="btn" id="btn-upload">Enviar</button>
    </div>
    <div class="row cols-3" style="margin-top:10px">
      <select id="up-filter">
        <option value="all">Todos</option>
        <option value="video">Vídeo</option>
        <option value="image">Imagem</option>
      </select>
      <input id="up-search" placeholder="Buscar por nome...">
      <span></span>
    </div>
    <div class="list" id="up-list" style="margin-top:12px"></div>
  </section>

  <!-- Playlist -->
  <section class="card">
    <h2>Playlist</h2>
    <div class="row cols-3">
      <select id="pl-terminal"></select>
      <button class="btn secondary" id="btn-load-pl">Carregar Playlist</button>
      <span></span>
    </div>

    <div class="row cols-3" style="margin-top:10px">
      <select id="pl-type">
        <option value="video">Vídeo</option>
        <option value="image">Imagem</option>
        <option value="rss">RSS</option>
      </select>
      <!-- NOVO: escolher dos uploads sem digitar -->
      <select id="pl-choose-upload"></select>
      <input id="pl-dur" placeholder="Duração (s) p/ imagem/RSS">
    </div>

    <div class="row cols-3" style="margin-top:10px">
      <input id="pl-url" placeholder="(Opcional) URL manual ou /static/uploads/arquivo.ext">
      <button class="btn" id="btn-add-item">Adicionar</button>
      <button class="btn" id="btn-save-pl">Salvar Playlist</button>
    </div>

    <div class="list" id="pl-list" style="margin-top:12px"></div>
  </section>
</main>

<footer>
  Desenvolvido por <a href="{{ support_link }}" target="_blank">Studio RS Ilhabela</a>
</footer>

<script>
const $ = s => document.querySelector(s);
const api = (u,o={}) => fetch(u,o).then(async r=>{const t=await r.text();try{return JSON.parse(t)}catch{return {ok:r.ok,raw:t}}});

let uploadsAll = [];
let currentPlaylist = { code:"", items:[] };

function el(tag,props={},children=[]){const e=document.createElement(tag);
  Object.entries(props).forEach(([k,v])=>{
    if(k==="class")e.className=v;
    else if(k==="text")e.textContent=v;
    else if(typeof v==="function")e.addEventListener("click",v);
    else e.setAttribute(k,v);
  });
  (Array.isArray(children)?children:[children]).forEach(c=>c&&e.appendChild(c));
  return e;
}

/* -------- terminais -------- */
async function loadTerminals(){
  const list=await api("/api/v1/terminals");
  const wrap=$("#term-list"); wrap.innerHTML="";
  const sel=$("#pl-terminal"); sel.innerHTML="";
  sel.appendChild(el("option",{value:"",text:"— selecione um terminal —"}));

  list.forEach(t=>{
    wrap.appendChild(el("div",{class:"item"},[
      el("div",{},[
        el("div",{text:`${t.code} — ${t.name}`}),
        el("small",{class:"muted",text:t.group?`Grupo: ${t.group}`:"Sem grupo"})
      ]),
      el("div",{class:"stack"},[
        el("span",{class:"pill"}, el("span",{text:(t.last_seen||"nunca")})),
        el("a",{class:"pill",href:`/api/v1/config?code=${encodeURIComponent(t.code)}`,target:"_blank",text:"ver config"})
      ])
    ]));
    sel.appendChild(el("option",{value:t.code,text:`${t.code} — ${t.name}`}));
  });
}

/* -------- uploads -------- */
async function loadUploads(){
  uploadsAll = await api("/api/v1/uploads");
  renderUploads();
  fillChooseUploads();
}

function renderUploads(){
  const type=$("#up-filter").value;
  const q=($("#up-search").value||"").toLowerCase();
  const wrap=$("#up-list"); wrap.innerHTML="";
  uploadsAll
    .filter(u=>type==="all"||u.type===type)
    .filter(u=>!q||u.name.toLowerCase().includes(q))
    .forEach(u=>{
      wrap.appendChild(el("div",{class:"item"},[
        el("div",{},[
          el("div",{text:u.name}),
          el("small",{class:"muted",text:`${u.type} • ${u.bytes} bytes`})
        ]),
        el("div",{class:"stack"},[
          el("a",{class:"pill",href:u.url,target:"_blank",text:"abrir"}),
          el("button",{class:"pill",onclick:()=>{$("#pl-choose-upload").value=u.url; $("#pl-url").value=u.url;}}, "usar")
        ])
      ]));
    });
}

function fillChooseUploads(){
  const sel=$("#pl-choose-upload");
  sel.innerHTML="";
  sel.appendChild(el("option",{value:"",text:"— escolher dos uploads —"}));
  uploadsAll.forEach(u=>{
    sel.appendChild(el("option",{value:u.url,text:`[${u.type}] ${u.name}`}));
  });
}

$("#up-filter").oninput = renderUploads;
$("#up-search").oninput = renderUploads;

$("#btn-upload").onclick = async ()=>{
  const files=$("#up-files").files;
  if(!files||!files.length){ alert("Selecione arquivos."); return; }
  const fd=new FormData();
  [...files].forEach(f=>fd.append("files[]",f));
  const r=await fetch("/api/v1/upload",{method:"POST",body:fd});
  const j=await r.json().catch(()=>({}));
  if(!j.ok){ alert("Upload falhou: "+(j.error||"")); return; }
  $("#up-files").value="";
  await loadUploads();
};

/* -------- playlist -------- */
function renderPlaylist(){
  const wrap=$("#pl-list"); wrap.innerHTML="";
  currentPlaylist.items.forEach((it,i)=>{
    const head = it.type.toUpperCase();
    const dur = (it.type==="image"||it.type==="rss")?` • ${it.duration||10}s`:"";
    wrap.appendChild(el("div",{class:"item"},[
      el("div",{},[
        el("div",{text:`[${head}] ${it.url}`}),
        el("small",{class:"muted",text:dur})
      ]),
      el("div",{class:"stack"},[
        el("a",{class:"pill",href:it.url,target:"_blank",text:"ver"}),
        el("button",{class:"pill",onclick:()=>{currentPlaylist.items.splice(i,1);renderPlaylist();}}, "remover")
      ])
    ]));
  });
}

$("#btn-load-pl").onclick = async ()=>{
  const code=$("#pl-terminal").value;
  if(!code){alert("Selecione o terminal.");return;}
  const j=await api(`/api/v1/playlist/${encodeURIComponent(code)}`);
  currentPlaylist={code,items:j.items||[]};
  renderPlaylist();
};

$("#btn-add-item").onclick = ()=>{
  if(!currentPlaylist.code){ alert("Selecione o terminal."); return; }

  let url = $("#pl-choose-upload").value || $("#pl-url").value.trim();
  if(!url){ alert("Escolha um upload ou informe a URL."); return; }

  const type = $("#pl-type").value;
  const dur = parseInt($("#pl-dur").value||"10",10);
  const item={type,url};
  if(type==="image"||type==="rss") item.duration = dur;

  currentPlaylist.items.push(item);
  $("#pl-url").value=""; $("#pl-dur").value=""; $("#pl-choose-upload").value="";
  renderPlaylist();
};

$("#btn-save-pl").onclick = async ()=>{
  if(!currentPlaylist.code){ alert("Selecione o terminal."); return; }
  const r=await fetch(`/api/v1/playlist/${encodeURIComponent(currentPlaylist.code)}`,{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({items:currentPlaylist.items})
  });
  if(!r.ok){ alert("Erro ao salvar."); return; }
  alert("Playlist salva.");
};

/* init */
loadTerminals();
loadUploads();
</script>
</body>
</html>
