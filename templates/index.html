<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>{{ branding.name }} — Painel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --primary: {{ branding.primary_color }}; }
    body { font-family: system-ui, Arial, sans-serif; margin:0; color:#0b0b0b; }
    header { background: var(--primary); color:#fff; padding:12px 16px; display:flex; align-items:center; gap:12px; }
    header img { height:36px; width:auto; }
    header .brand { font-weight:800; letter-spacing:.5px; }
    main { padding: 16px; display:grid; gap:16px; grid-template-columns: 1fr 1fr; }
    h2 { margin:.2rem 0 .6rem; color:#0a2458; }
    .card { border:1px solid #e5e7eb; border-radius:12px; padding:12px; background:#fff; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:.4rem 0; }
    input[type=text], input[type=number] { padding:8px 10px; border:1px solid #d1d5db; border-radius:8px; min-width: 140px; }
    button { padding:8px 12px; border:1px solid var(--primary); color:var(--primary); background:#fff; border-radius:10px; cursor:pointer; font-weight:700; }
    button:hover { background: var(--primary); color:#fff; }
    ul { margin:.4rem 0; padding-left:18px; }
    .pill { padding:2px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:.85rem; }
    .list { max-height: 320px; overflow:auto; border:1px dashed #cbd5e1; border-radius:8px; padding:8px; }
    .item { display:flex; justify-content:space-between; align-items:center; padding:6px; border-bottom:1px solid #f1f5f9; font-size:.95rem; }
    .item:last-child{border-bottom:0}
    .muted { color:#64748b; font-size:.9rem; }
    footer { padding:12px 16px; border-top:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center; }
    a { color: var(--primary); text-decoration: none; }
  </style>
</head>
<body>
<header>
  {% if branding.logo_url %}
    <img src="{{ branding.logo_url }}" alt="logo" onerror="this.style.display='none'"/>
  {% endif %}
  <div class="brand">{{ branding.name }}</div>
</header>

<main>
  <!-- CLIENTE / TERMINAIS -->
  <section class="card">
    <h2>Cliente & Terminais</h2>
    <div class="row">
      <input id="client_code" placeholder="Código cliente (ex.: 1 ou 001)" />
      <input id="client_name" placeholder="Nome do cliente" />
    </div>
    <div class="row">
      <input id="client_terms" type="number" min="1" value="1" title="Qtde terminais"/>
      <input id="client_days" type="number" min="1" value="30" title="Dias de licença"/>
      <button onclick="createClient()">Criar/Atualizar</button>
      <a class="pill" href="/clients" title="Gerenciar licenças">Gerenciar licenças →</a>
    </div>
    <div class="muted">Ao criar 3 terminais para cliente 1, os códigos ficam: <b>001-01</b>, <b>001-02</b>, <b>001-03</b>.</div>
    <div id="client_msg" class="muted"></div>
  </section>

  <!-- UPLOAD -->
  <section class="card">
    <h2>Uploads</h2>
    <div class="row">
      <input type="file" id="file" multiple />
      <button onclick="doUpload()">Enviar</button>
      <button onclick="refreshUploads()">Atualizar lista</button>
    </div>
    <div class="list" id="uploads_list"></div>
  </section>

  <!-- PLAYLIST BUILDER -->
  <section class="card">
    <h2>Playlist por Terminal</h2>
    <div class="row">
      <input id="term_code" placeholder="Code do terminal (ex.: 001-01)"/>
      <input id="img_dur" type="number" min="1" value="10" title="Duração padrão p/ imagens (s)"/>
      <input id="refresh_minutes" type="number" min="1" value="10" title="Refresh (min)"/>
      <button onclick="savePlaylist()">Salvar Playlist</button>
      <button onclick="loadConfig()">Ver Config</button>
    </div>
    <div class="muted">Vídeos tocam até o fim. Imagens usam a duração acima (ajustável por item).</div>
    <div class="list" id="playlist_list"></div>
  </section>

  <!-- DIAGNÓSTICO -->
  <section class="card">
    <h2>Status do Terminal</h2>
    <pre id="diag" class="muted">—</pre>
    <div class="row">
      <a href="{{ support_link }}" target="_blank">Suporte WhatsApp</a>
    </div>
  </section>
</main>

<footer>
  <div class="muted">© {{ branding.name }}</div>
  <a href="{{ support_link }}" target="_blank">Desenvolvido por: Studio RS Ilhabela — Suporte</a>
</footer>

<script>
let uploads = [];
let playlist = []; // {url, type, duration}

function el(id){ return document.getElementById(id); }

function itemRow(label, right){
  const div = document.createElement('div');
  div.className = 'item';
  div.innerHTML = `<span>${label}</span>`;
  if (right) div.appendChild(right);
  return div;
}

async function createClient(){
  const client_code = el('client_code').value.trim();
  const name = el('client_name').value.trim();
  const terminals = parseInt(el('client_terms').value || '1',10);
  const license_days = parseInt(el('client_days').value || '30',10);
  if(!client_code){ alert('Informe o código do cliente'); return; }
  const r = await fetch('/api/v1/client', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({client_code, name, terminals, license_days})
  });
  const j = await r.json();
  el('client_msg').textContent = j.ok ? 'Cliente salvo.' : ('Erro: '+(j.error||''));
}

async function refreshUploads(){
  const r = await fetch('/api/v1/uploads');
  const j = await r.json();
  const box = el('uploads_list');
  box.innerHTML = '';
  if (!j.ok){ box.textContent = 'Erro ao listar uploads'; return; }
  uploads = j.items;
  for (const u of uploads){
    const btn = document.createElement('button');
    btn.textContent = 'Adicionar';
    btn.onclick = ()=> addToPlaylist(u);
    box.appendChild(itemRow(`${u.type.toUpperCase()} — ${u.filename}`, btn));
  }
}

function addToPlaylist(u){
  const isImage = u.type === 'image';
  const dur = isImage ? parseInt(el('img_dur').value || '10', 10) : 0;
  playlist.push({url: u.url, type: u.type, duration: dur});
  renderPlaylist();
}

function renderPlaylist(){
  const box = el('playlist_list');
  box.innerHTML = '';
  playlist.forEach((p, idx)=>{
    const right = document.createElement('div');
    right.className = 'row';
    if (p.type === 'image'){
      const inp = document.createElement('input');
      inp.type = 'number'; inp.min = '1'; inp.value = p.duration;
      inp.style.width = '70px';
      inp.onchange = ()=> { p.duration = parseInt(inp.value||'10',10); };
      right.appendChild(inp);
    } else {
      const span = document.createElement('span');
      span.className = 'muted';
      span.textContent = 'vídeo';
      right.appendChild(span);
    }
    const rm = document.createElement('button');
    rm.textContent = 'Remover';
    rm.onclick = ()=> { playlist.splice(idx,1); renderPlaylist(); };
    right.appendChild(rm);
    box.appendChild(itemRow(`${idx+1}. ${p.type.toUpperCase()} — ${p.url}`, right));
  });
}

async function doUpload(){
  const fi = el('file');
  if (!fi.files || !fi.files.length){ alert('Selecione arquivos'); return; }
  for (const f of fi.files){
    const fd = new FormData();
    fd.append('file', f);
    const r = await fetch('/upload', { method:'POST', body: fd });
    const j = await r.json();
    if(!j.ok){ alert('Falhou upload: '+(j.error||'')); break; }
  }
  fi.value = '';
  refreshUploads();
}

async function savePlaylist(){
  const code = el('term_code').value.trim();
  if (!code){ alert('Informe o code do terminal (ex.: 001-01)'); return; }
  if (playlist.length === 0){ alert('Playlist vazia'); return; }
  const refresh_minutes = parseInt(el('refresh_minutes').value || '10', 10);
  const r = await fetch('/api/v1/playlist', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ code, items: playlist, refresh_minutes })
  });
  const j = await r.json();
  if (!j.ok){ alert('Erro ao salvar: ' + (j.error||'')); return; }
  alert('Playlist salva para ' + j.code);
}

async function loadConfig(){
  const code = el('term_code').value.trim();
  if (!code){ alert('Informe o code do terminal'); return; }
  const r = await fetch('/api/v1/config?code=' + encodeURIComponent(code));
  const txt = await r.text();
  el('diag').textContent = txt;
}

refreshUploads();
</script>
</body>
</html>
