<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ branding.name or 'Studio RS TV' }} — Painel</title>
  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --muted:#94a3b8;
      --text:#e2e8f0; --accent: {{ branding.primary_color or '#0d1b2a' }};
      --ok:#16a34a; --warn:#f59e0b; --err:#ef4444;
    }
    *{box-sizing:border-box} body{margin:0;font:14px/1.4 ui-sans-serif,system-ui;background:var(--bg);color:var(--text)}
    header{padding:16px 20px;background:var(--card);display:flex;gap:16px;align-items:center;border-bottom:1px solid #1f2937}
    header img{height:28px}
    header h1{font-size:16px;margin:0;font-weight:600}
    main{max-width:1100px;margin:24px auto;padding:0 16px;display:grid;gap:16px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:10px;padding:16px}
    .row{display:grid;gap:10px}
    .row-2{grid-template-columns:1fr 1fr}
    label{font-size:12px;color:var(--muted)}
    input,select,button{width:100%;padding:10px;border-radius:8px;border:1px solid #263244;background:#0e1626;color:var(--text)}
    button{cursor:pointer;background:var(--accent);border-color:transparent}
    .btn-secondary{background:#19243a}
    .btn-ok{background:var(--ok)} .btn-warn{background:var(--warn)} .btn-ghost{background:#0e1626}
    .list{max-height:280px;overflow:auto;border:1px solid #23314d;border-radius:8px}
    .item{display:flex;justify-content:space-between;gap:8px;padding:8px 10px;border-bottom:1px solid #1f2a46}
    .item small{color:var(--muted)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:#12203c;color:#cbd5e1;border:1px solid #213055}
    .stack{display:flex;gap:8px;flex-wrap:wrap}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .muted{color:var(--muted)} .ok{color:var(--ok)} .err{color:var(--err)}
    .hr{height:1px;background:#1f2a46;margin:8px 0}
    .toast{position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;border:1px solid #374151;padding:10px 14px;border-radius:8px}
    .mini{font-size:12px}
  </style>
</head>
<body>
  <header>
    {% if branding.logo %}
      <img src="{{ branding.logo }}" alt="logo">
    {% endif %}
    <h1>{{ branding.name or 'Studio RS TV' }} — Painel</h1>
    <span class="pill">{{ branding.primary_color or '#0d1b2a' }}</span>
    <div style="margin-left:auto"></div>
    <a class="pill" href="{{ support_link }}" target="_blank">Suporte WhatsApp</a>
  </header>

  <main>
    <!-- CLIENTE / TERMINAIS -->
    <section class="card">
      <h3 style="margin-top:0">Cliente & Terminais</h3>
      <div class="row row-2">
        <div>
          <label>Nome do cliente</label>
          <input id="cliName" placeholder="ex.: João" />
        </div>
        <div>
          <label>Código do cliente</label>
          <input id="cliCode" placeholder="ex.: 001" />
        </div>
      </div>
      <div class="row row-2">
        <div>
          <label>Qtd de terminais</label>
          <input id="cliQty" type="number" min="1" value="1" />
        </div>
        <div>
          <label>Licença (dias)</label>
          <input id="cliDays" type="number" min="1" value="30" />
        </div>
      </div>
      <div class="stack" style="margin-top:10px">
        <button id="btnCreate" style="max-width:220px">Criar/Atualizar</button>
        <button id="btnReloadTerms" class="btn-secondary" style="max-width:180px">Recarregar terminais</button>
        <span id="createMsg" class="muted"></span>
      </div>

      <div class="hr"></div>
      <div class="row row-2">
        <div>
          <label>Selecionar terminal (topo)</label>
          <select id="selTop"></select>
        </div>
        <div style="display:flex;align-items:flex-end;gap:8px">
          <button id="btnLoadTop" class="btn-secondary" style="max-width:200px">Carregar Playlist</button>
          <span id="topInfo" class="muted mini"></span>
        </div>
      </div>
    </section>

    <!-- UPLOADS -->
    <section class="card">
      <h3 style="margin-top:0">Uploads</h3>
      <div class="stack">
        <input id="inpFiles" type="file" multiple style="max-width:420px" />
        <button id="btnUpload" style="max-width:140px">Enviar</button>
        <button id="btnList" class="btn-secondary" style="max-width:180px">Atualizar lista</button>
        <span id="uploadMsg" class="muted"></span>
      </div>
      <div id="uploadList" class="list" style="margin-top:10px"></div>
    </section>

    <!-- PLAYLIST -->
    <section class="card">
      <h3 style="margin-top:0">Playlist por Terminal</h3>
      <div class="grid-2">
        <div>
          <label>Terminal (playlist)</label>
          <select id="selTerm"></select>
        </div>
        <div>
          <label>Nome da campanha (opcional)</label>
          <input id="inpCampaign" placeholder="ex.: Promo Agosto" />
        </div>
      </div>

      <div class="stack" style="margin-top:8px">
        <button id="btnSyncTop" class="btn-secondary">Sincronizar com topo</button>
        <button id="btnLoadPL" class="btn-secondary">Carregar Playlist</button>
        <button id="btnClear" class="btn-ghost">Limpar builder</button>
      </div>

      <div class="row" style="margin-top:8px">
        <label>Mídia/Tipo</label>
        <select id="selType">
          <option value="video">Vídeo</option>
          <option value="image">Imagem</option>
          <option value="rss">RSS</option>
        </select>
        <select id="selUpload"></select>
        <input id="inpURL" placeholder="URL ou /static/uploads/arquivo.ext" />
        <input id="inpDur" type="number" min="1" placeholder="Duração (s) p/ imagem/RSS" />
        <button id="btnAdd" class="btn-ok">Adicionar</button>
      </div>

      <div id="builder" class="list" style="margin-top:10px"></div>
      <div class="stack" style="margin-top:10px">
        <button id="btnSave" class="btn-ok">Salvar Playlist</button>
        <span id="saveMsg" class="muted"></span>
      </div>
    </section>

    <!-- DIAGNÓSTICO -->
    <section class="card">
      <h3 style="margin-top:0">Diagnóstico</h3>
      <div class="stack">
        <button id="btnPing" class="btn-secondary">/api/v1/ping</button>
        <button id="btnViewCfg" class="btn-secondary">/api/v1/config</button>
      </div>
      <pre id="diag" class="list" style="padding:10px;white-space:pre-wrap"></pre>
    </section>
  </main>

  <div id="toast" class="toast" style="display:none"></div>

  <script>
    // helpers
    const $ = sel => document.querySelector(sel);
    const toast = (msg) => { const t = $("#toast"); t.innerText = msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 2500); }
    const api = (url, opts={}) =>
      fetch(url, Object.assign({headers: {'Accept':'application/json'}}, opts))
      .then(r => r.ok ? r.json() : r.json().catch(()=>({})).then(j=>Promise.reject(j.error||r.statusText)));

    const selTop = $("#selTop");
    const selTerm = $("#selTerm");
    const uploadList = $("#uploadList");
    const selUpload = $("#selUpload");
    const builder = $("#builder");

    let currentUploads = [];
    let building = []; // [{type,url,duration?}]

    const renderUploads = () => {
      uploadList.innerHTML = "";
      selUpload.innerHTML = "";
      currentUploads.forEach(u=>{
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div><b>${u.type}</b><br><small>${u.url}</small></div>
          <div class="stack"><button class="btn-secondary mini" data-url="${u.url}" data-type="${u.type}">usar</button></div>`;
        uploadList.appendChild(div);

        const opt = document.createElement("option");
        opt.value = u.url; opt.textContent = `${u.type.toUpperCase()} • ${u.url}`;
        selUpload.appendChild(opt);
      });
      uploadList.querySelectorAll("button[data-url]").forEach(btn=>{
        btn.onclick = () => {
          $("#selType").value = btn.dataset.type;
          $("#inpURL").value = btn.dataset.url;
          if(btn.dataset.type !== "video") $("#inpDur").value = 10;
        };
      });
    };

    const renderBuilder = () => {
      builder.innerHTML = "";
      building.forEach((it, i)=>{
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div><b>${it.type}</b> ${it.duration?`<small>(${it.duration}s)</small>`:''}<br><small>${it.url}</small></div>
          <div class="stack">
            <button class="btn-secondary mini" data-up="${i}">↑</button>
            <button class="btn-secondary mini" data-down="${i}">↓</button>
            <button class="btn-ghost mini" data-del="${i}">remover</button>
          </div>`;
        builder.appendChild(div);
      });
      builder.querySelectorAll("button[data-up]").forEach(b=>b.onclick=()=>{
        const i=+b.dataset.up; if(i>0){ [building[i-1],building[i]]=[building[i],building[i-1]]; renderBuilder(); }
      });
      builder.querySelectorAll("button[data-down]").forEach(b=>b.onclick=()=>{
        const i=+b.dataset.down; if(i<building.length-1){ [building[i+1],building[i]]=[building[i],building[i+1]]; renderBuilder(); }
      });
      builder.querySelectorAll("button[data-del]").forEach(b=>b.onclick=()=>{
        building.splice(+b.dataset.del,1); renderBuilder();
      });
    };

    // carga inicial
    const loadUploads = () => api('/api/v1/uploads').then(j=>{ currentUploads=j.uploads||[]; renderUploads(); }).catch(e=>toast('Erro uploads: '+e));
    const loadTerms = () => api('/api/v1/terminal?list=1').then(j=>{
      const list = j.terminals||[];
      const fill = (sel) => { sel.innerHTML=""; list.forEach(t=>{ const o=document.createElement('option'); o.value=t.code; o.textContent=t.display; sel.appendChild(o); }); }
      fill(selTop); fill(selTerm);
    }).catch(e=>toast('Erro terminais: '+e));

    // eventos principais
    document.addEventListener('DOMContentLoaded', ()=>{
      loadTerms(); loadUploads();

      // CRIAR / ATUALIZAR
      $("#btnCreate").onclick = () => {
        const body = {
          name: $("#cliName").value.trim(),
          code: $("#cliCode").value.trim(),
          qty:  parseInt($("#cliQty").value||"1",10),
          days: parseInt($("#cliDays").value||"30",10)
        };
        if(!body.name || !body.code) return toast("Preencha nome e código");
        api('/api/v1/terminal', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)})
          .then(j=>{ $("#createMsg").innerText = `Criado(s): ${j.created}`; toast('✓ Terminais criados'); return loadTerms(); })
          .catch(e=>toast('Erro criar: '+e));
      };

      $("#btnReloadTerms").onclick = ()=> loadTerms();

      // carregar playlist do topo / do seletor
      const loadPlaylist = (code, infoEl) => {
        return api('/api/v1/terminal?code='+encodeURIComponent(code))
          .then(j=>{
            building = (j.playlist||[]).slice();
            renderBuilder();
            if(infoEl) infoEl.innerText = `Itens: ${building.length}`;
          })
          .catch(e=>toast('Erro playlist: '+e));
      };
      $("#btnLoadTop").onclick = ()=> loadPlaylist(selTop.value, $("#topInfo"));
      $("#btnLoadPL").onclick  = ()=> loadPlaylist(selTerm.value);

      // SYNC COM TOPO
      $("#btnSyncTop").onclick = ()=> { selTerm.value = selTop.value; loadPlaylist(selTerm.value); };

      // LIMPAR
      $("#btnClear").onclick = ()=> { building=[]; renderBuilder(); };

      // UPLOAD
      $("#btnUpload").onclick = ()=>{
        const files = $("#inpFiles").files;
        if(!files || !files.length) return toast("Escolha arquivo(s)");
        const fd = new FormData();
        [...files].forEach(f=>fd.append('files', f));
        api('/api/v1/upload', {method:'POST', body:fd})
          .then(_=>{ $("#uploadMsg").innerText="Enviado"; loadUploads(); toast('✓ Upload concluído'); })
          .catch(e=>toast('Erro upload: '+e));
      };
      $("#btnList").onclick = ()=> loadUploads();

      // ADICIONAR ITEM
      $("#btnAdd").onclick = ()=>{
        const type = $("#selType").value;
        const url  = ($("#inpURL").value || $("#selUpload").value || "").trim();
        if(!url) return toast("Informe URL ou escolha dos uploads");
        const item = {type, url};
        if(type!=='video'){
          const d = parseInt($("#inpDur").value||"0",10);
          item.duration = d>0? d : 10;
        }
        building.push(item);
        renderBuilder();
      };

      // SALVAR PLAYLIST
      $("#btnSave").onclick = ()=>{
        const code = selTerm.value;
        if(!code) return toast("Escolha um terminal");
        const body = { code, campaign: $("#inpCampaign").value || null, items: building };
        api('/api/v1/playlist', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)})
          .then(_=>{ $("#saveMsg").innerText="Playlist salva"; toast('✓ Playlist salva'); })
          .catch(e=>toast('Erro salvar: '+e));
      };

      // DIAG
      $("#btnPing").onclick = ()=> api('/api/v1/ping').then(j=>$("#diag").textContent=JSON.stringify(j,null,2));
      $("#btnViewCfg").onclick = ()=> {
        const code = selTerm.value || selTop.value;
        if(!code) return toast("Escolha um terminal");
        api('/api/v1/config?code='+encodeURIComponent(code)).then(j=>$("#diag").textContent=JSON.stringify(j,null,2));
      };
    });
  </script>
</body>
</html>
